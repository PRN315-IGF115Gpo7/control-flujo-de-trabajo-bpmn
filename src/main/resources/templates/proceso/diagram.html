<!DOCTYPE html>
<html layout:decorate="~{layouts/layout}">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Document</title>

  <!-- necessary stylesheets -->

  <link rel="stylesheet" th:href="@{/bpmn/css/diagram-js.css}">
  <link rel="stylesheet" th:href="@{/bpmn/css/bpmn.css}">
  <link rel="stylesheet" th:href="@{/css/configurar-actividad.css}">
  
  <script th:src="@{/bpmn/js/bpmn-viewer.development.js}"></script>
  <script th:src="@{/bpmn/js/bpmn-modeler.development.js}"></script>
</head>

<body>
  <h1 class="m-0 text-dark" layout:fragment="titulo_seccion">Control de Flujos de Trabajo</h1>

	<ol class="breadcrumb float-sm-right" layout:fragment="breadcrumb">
        <li class="breadcrumb-item"><a th:href="@{/index}">Home</a></li>
        <li class="breadcrumb-item active">Diseñar proceso</li>
    </ol>

	<div layout:fragment="content" style="height: 100vh;">
	
	<div style="position: relative;">
		<h5 id="nombre-proceso" ></h5>
		<button class="btn btn-success btn-validar"><i class="far fa-check-square fa-lg"></i></button>
		<button class="btn btn-primary btn-automatizar" disabled><i class="fas fa-cog fa-lg"></i></button>
		<button id="btn-guardar-cambios" class="btn btn-dark btn-guardar"><i class="far fa-save fa-lg"></i></button>
		
		
		
	</div>
	
	<div id="canvas" style="height: 100%"></div>
	
	<div class="config-actividad">
		
		<i class="fas fa-arrow-left fa-lg mb-3" id="close-form"></i>
		
		<div id="agregar-variable" class="not-show">
			<form id="varsForm" action="#">
				<input type="hidden" id="hiddenElementoBpmnId" value=""/>
				<div class="form-group">
					<label id="tipo-elemento-bpmn"></label>
					<input class="form-control" id="nombre-actividad" disabled/>
				</div>
				
				<div class="form-group">
		          	<label>Seleccione la variable</label>
		          	<select class="form-control" id="idVariables">
		            	<option value="">Seleccione una opción</option>
		          	</select>
	        	</div>
	        	<div id="permitirEscrituraChkbx" class="form-group">
					<div class="custom-control custom-checkbox">
						<input type="checkbox" class="custom-control-input" id="esEscritura" 
							> 
						<label class="custom-control-label" for="esEscritura">Se permite Escritura</label>
						<small id="emailHelp" class="form-text text-muted">(Seleccione para indicar que el participante podrá responder a la actividad).</small>
					</div>
				</div>
				<button class="btn btn-primary btn-sm" onclick="agregarVariable(event)">Agregar</button>
			</form>
		
			<div class="card mt-3">
              <div class="card-header">
                <label>Variables Agregadas a Actividad</label>
              </div>
              <!-- /.card-header -->
              <div class="card-body p-0">
                <table id="variablesAgregadasTable" class="table table-sm">
                  <thead>
                    <tr>
                      <th style="width: 10px">#</th>
                      <th>Variable</th>
                      <th>Tipo</th>
					  <th style="width: 40px">Escritura</th>
					  <th>Acciones</th>
                    </tr>
                  </thead>
                  <tbody id="variablesBodyTable">
                    
                  </tbody>
                </table>
              </div>
              <!-- /.card-body -->
            </div>
		</div>
		<div id="set-participante" class="not-show">
			<div class="form-group">
	          	<label>Seleccione la entidad responsable</label>
	          	<select class="form-control" id="idEntidad">
	            	<option value="">Seleccione una opción</option>
	          	</select>
        	</div>
        	<button class="btn btn-primary btn-sm" id="btn-set-participante">Establecer</button>
	        
		</div>
		
	</div>
	
      
	</div>


	<section layout:fragment="scripts">
	
		<script th:inline="javascript">
		
			/*<![CDATA[*/
				let proceso = /*[[${proceso}]]*/ null;
				
				let cargos = /*[[${cargos}]]*/ null;
				
				let variables = /*[[${proceso.variables}]]*/ null;
				
			/*]]>*/
			
			//elemento seleccionado
			var elementoSeleccionado = null;
			var participantes = [];

			$('body').prop("class", "sidebar-mini layout-fixed sidebar-collapse")

			var baseUrl = location.protocol+'//'+location.hostname+(location.port ? ':'+location.port: '');
			var diagramUrl = `${baseUrl}/bpmn/base.bpmn`;

			// modeler instance
			var bpmnModeler = new BpmnJS({
				container: '#canvas',
				keyboard: {
					bindTo: window
				}
			});
			
			  // load external diagram file via AJAX and open it
			$.get(diagramUrl, openDiagram, 'text');

			/**
			 * Open diagram in our modeler instance.
			 * @param {String} bpmnXML diagram to display
			 */
			async function openDiagram(bpmnXML) {
			// import diagram
				try {
				var xmlBase =  "<?xml version=\"1.0\" encoding=\"UTF-8\"?><definitions xmlns=\"http://www.omg.org/spec/BPMN/20100524/MODEL\" xmlns:bpmndi=\"http://www.omg.org/spec/BPMN/20100524/DI\" xmlns:omgdc=\"http://www.omg.org/spec/DD/20100524/DC\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" targetNamespace=\"\" xsi:schemaLocation=\"http://www.omg.org/spec/BPMN/20100524/MODEL http://www.omg.org/spec/BPMN/2.0/20100501/BPMN20.xsd\"><collaboration id=\"Collaboration_1k4vxpn\"><participant id=\"Participant_0axkjtm\" name=\"NombreProceso\" processRef=\"Process_0g3egdl\" /></collaboration><process id=\"Process_0g3egdl\"><laneSet id=\"LaneSet_0el1pb8\"><lane id=\"Lane_1wcf2uc\" name=\"Participante1\" /></laneSet></process><bpmndi:BPMNDiagram id=\"sid-74620812-92c4-44e5-949c-aa47393d3830\"><bpmndi:BPMNPlane id=\"sid-cdcae759-2af7-4a6d-bd02-53f3352a731d\" bpmnElement=\"Collaboration_1k4vxpn\"><bpmndi:BPMNShape id=\"Participant_0axkjtm_di\" bpmnElement=\"Participant_0axkjtm\" isHorizontal=\"true\"><omgdc:Bounds x=\"80\" y=\"100\" width=\"600\" height=\"250\" /></bpmndi:BPMNShape><bpmndi:BPMNShape id=\"Lane_1wcf2uc_di\" bpmnElement=\"Lane_1wcf2uc\" isHorizontal=\"true\"><omgdc:Bounds x=\"110\" y=\"100\" width=\"570\" height=\"250\" /></bpmndi:BPMNShape></bpmndi:BPMNPlane></bpmndi:BPMNDiagram></definitions>";    
				
				if(proceso != null){
					$("#nombre-proceso").append(proceso.procesoNombre);
					if(proceso.proceoXml != null){
						xmlBase = proceso.proceoXml;
					}else{
						xmlBase = xmlBase.replace("NombreProceso", proceso.procesoNombre);
					}
				}
			
				await bpmnModeler.importXML(xmlBase);
				// access modeler components
				var canvas = bpmnModeler.get('canvas');
				//var overlays = bpmnModeler.get('overlays');
				
				//Evento click de los elementos
				canvas._eventBus.on('element.click', function(e) {
					// e.element = the model element
					// e.gfx = the graphical element
					hideForm();
					
					//Set Elemento seleccionado
					elementoSeleccionado = e.element;
					
					switch(e.element.type) {
					case "bpmn:Task":
						$(".config-actividad").addClass("show-form");
						$("#agregar-variable").removeClass("not-show");
						$("#tipo-elemento-bpmn").empty();
						$("#tipo-elemento-bpmn").append("Nombre de Actividad");
						if(e.element.businessObject.name){
							$("#nombre-actividad").val(e.element.businessObject.name);
						}else{
							$("#nombre-actividad").val("");
						}
						//cargar Variables DC16009
						$("#permitirEscrituraChkbx").removeClass('d-none');
						$("#hiddenElementoBpmnId").val(e.element.id);
						inicializarVariables(e.element.id);
						break;
					case "bpmn:ExclusiveGateway":
						$(".config-actividad").addClass("show-form");
						$("#agregar-variable").removeClass("not-show");
						$("#tipo-elemento-bpmn").empty();
						$("#tipo-elemento-bpmn").append("Nombre de Compuerta");
						if(e.element.businessObject.name){
							$("#nombre-actividad").val(e.element.businessObject.name);
						}else{
							$("#nombre-actividad").val("");
						}
						//cargar Variables DC16009
						$("#permitirEscrituraChkbx").addClass('d-none');
						$("#hiddenElementoBpmnId").val(e.element.id);
						inicializarVariables(e.element.id);
						
						break;
					case "bpmn:Lane":
						$(".config-actividad").addClass("show-form");
						$("#set-participante").removeClass("not-show");
						break;
					default:
						// code block
					}
				});
				
				canvas._eventBus.on("shape.added", function(e){
					console.log("add");
					if(e.element.type === "bpmn:Task" || e.element.type === "bpmn:ExclusiveGateway" ||
							e.element.type === "bpmn:StartEvent" || e.element.type === "bpmn:EndEvent"){
						createElementoBpmn(e.element.id, e.element.id, e.element.type, proceso.idProceso);
						if(e.element.type === "bpmn:Task"){
							e.element.businessObject.name = e.element.id;
						}
					}
				});
				
				// zoom to fit full viewport
				canvas.zoom('fit-viewport');

				// add marker
				canvas.addMarker('SCAN_OK', 'needs-discussion');
				} catch (err) {
					console.error('could not import BPMN 2.0 diagram', err);
				}
				
			}
			 
			//Save diagram contents and print them to the console.
			async function exportDiagram() {
				try {
					var result = await bpmnModeler.saveXML({ format: true });
					alert('Diagram exported. Check the developer tools!');
					console.log('DIAGRAM', result.xml);
				}catch (err) {
					alert('could not save BPMN 2.0 diagram!');
					console.error('could not save BPMN 2.0 diagram', err);
				}
			}
		        
			$("#close-form").click(function() {
				hideForm();
			});
			
			$("#btn-guardar-cambios").click(function(){
				setProcesoXml();
			});
			
			$("#btn-set-participante").click(function(){
				setParticipante();
			});
			
			$(".btn-validar").click(function(){
				setProcesoXml();
				validarProceso();
			})
		       
			
			/*
			* Función que permite ocultar el formulario de configuración de actividades
			*/
			function hideForm(){
				$(".config-actividad").removeClass("show-form");
				$("#set-participante").addClass("not-show");
				$("#agregar-variable").addClass("not-show");
			}
			
			/*
			* inicializar el selector de cargos
			*/
			var htmlCargos = '';
			if(cargos != null){
				for (var i = 0; i < cargos.length; ++i) {
					htmlCargos += `<option value=${cargos[i].idCargo}>${cargos[i].nombreCargo}</option>`;
				}
				$("#idEntidad").append(htmlCargos);
			}
			
			/*
			* Funcion que permite crear o actualizar un elemento BPMN
			*/
			function createElementoBpmn(idDiagramaElementoBpmn, nombreElementoBpmn, tipoElementoBpmn, idProceso){
				var elemento = {
					"id_diagrama_elemento_bpmn" : idDiagramaElementoBpmn,
					"nombre_elemento_bpmn" : nombreElementoBpmn,
					"tipo_elemento_bpmn" : tipoElementoBpmn,
					"id_proceso": idProceso
				};
		
				$.post("/api/elemento-bpmn/create", elemento, function(data, status){
					console.log("Estado: " + status);
					console.log(data);
				});
			}
			
			/*
			* Funcion que actualizar el proceso (actualizar xml)
			*/
			async function setProcesoXml(){
				try {
					var result = await bpmnModeler.saveXML({ format: true });
					proceso.proceoXml = result.xml;
					$.post("/api/proceso/update-xml", {"xml": proceso.proceoXml, "id_proceso": proceso.idProceso}, function(data, status){
						console.log("Estado: " + status);
						console.log(data);
					});
				}catch (err) {
					xml = null;
				}
			}
			
			
			function setParticipante(){
				participantes.forEach(function(elemento, indice){
					if(elemento.id == elementoSeleccionado.id){
						participantes.splice(indice, 1);//elimina el elemento
					}
				});
				
				var canvas = bpmnModeler.get('canvas');
				var modeling = bpmnModeler.get('modeling');
				var lane = canvas._elementRegistry.get(elementoSeleccionado.id);
				modeling.updateProperties(lane,{
					"name": $('#idEntidad option').filter(':selected').text()
				});
				
				participantes.push({
					"id" : elementoSeleccionado.id,
					"id_cargo" : $("#idEntidad").val()
				});
			}
			

			function agregarVariable(e){
				e.preventDefault();
				var procesoId = proceso.idProceso;
				var elementoBpmnId = $("#hiddenElementoBpmnId").val();
				var variableId = $("#idVariables").val();
				var esEscritura = $("#esEscritura").is(":checked");

				console.log(procesoId);
				console.log(elementoBpmnId);
				console.log(variableId);
				console.log(esEscritura);

				$.post("/api/elemento-bpmn-formulario/create", 
					{"procesoId": procesoId,
					"elementoBpmnId": elementoBpmnId, 
					"variableId": variableId,
					"esEscritura": esEscritura}, 
					function(data, status){
					console.log("Estado: " + status);
					console.log(data);
					$('#varsForm').trigger("reset");
					inicializarVariables(elementoBpmnId);
				});
			}

			function inicializarVariables(elementoBpmnId){
				$.get("/api/obtener-variables-elemento/" + proceso.idProceso + "/" + elementoBpmnId,
				function(data, status){
					console.log("Estado: " + status);
					console.log(data);

					var htmlVariablesSelect = '<option value="">Seleccione una opción</option>';
					if(variables != null){
						for (var i = 0; i < variables.length; ++i) {
							var agregado = false;
							
							if(data){
								for(var j = 0; j < data.length; j++){
									if(variables[i].idVariable == data[j].idVariable){
										agregado = true;
									}
								}
							}

							if(! agregado){
								htmlVariablesSelect += `<option value=${variables[i].idVariable}>${variables[i].variableNombre}</option>`;
							}
						}
						$("#idVariables").html(htmlVariablesSelect);
					}

					var htmlVariablesTable = '';
					if(data){
						for (var i = 0; i < data.length; ++i) {
							
							var badge_class = "primary";
							
							if(data[i].tipoDato.tipoDatoNombre == "String" || data[i].tipoDato.tipoDatoNombre == "Date"){
								badge_class = "danger";
							}else if(data[i].tipoDato.tipoDatoNombre == "Boolean"){
								badge_class = "secondary";
							}

							var row = "<tr>"; 
							row += "<td>" + (i+1) + ".</td>";
							row += "<td>" + data[i].variableNombre + "</td>";
                      		row += `<td><span class="badge bg-${badge_class}">` + data[i].tipoDato.tipoDatoNombre + '</span></td>';
							if(data[i].esEscritura){  
                      			row += '<td style="vertical-align:middle; text-align:center"><i class="fas fa-user-edit"></i></td>';	
							}else{
								row += '<td style="vertical-align:middle; text-align:center"><i class="fas fa-eye"></i></td>';
							}
							row += `<td style="vertical-align:middle; text-align:center"><button class="btn btn-sm btn-danger" onclick="eliminarVariable(event, ${data[i].idVariable}, '${elementoBpmnId}');"><i class="fas fa-trash"></i></button></td>`;
							row += "</tr>";

							htmlVariablesTable += row;
						}
						$("#variablesBodyTable").html(htmlVariablesTable);
					}
				});
			}

			function eliminarVariable(e, variableId, elementoBpmnId){
				e.preventDefault();

				$.get("/api/eliminar-variable-elemento/" + proceso.idProceso + "/" + elementoBpmnId + "/" + variableId,
				function(data, status){
					console.log("Estado: " + status);
					console.log(data);
					inicializarVariables(elementoBpmnId);
				});
			}
			
			function validarProceso(){
			
				var elementos = bpmnModeler.get('elementRegistry').getAll();
				var i = 0;
				for(i = 0; i <= elementos.length; i++){
					var elemento = elementos[i];
					if(elemento != undefined){
						if(elemento.type === "bpmn:Task" || elemento.type === "bpmn:ExclusiveGateway" ||
								elemento.type === "bpmn:StartEvent" || elemento.type === "bpmn:EndEvent"){
							
							//set participante en elemento
							if(getCargo(elemento.businessObject.lanes[0].id)>0){
								var body = {
										"id_diagrama_elemento_bpmn" : elemento.id,
										"id_proceso" : proceso.idProceso,
										"id_cargo" : getCargo(elemento.businessObject.lanes[0].id)
								}
								$.post("/api/elemento-bpmn/update-participante", body , function(data, status){
									console.log("Estado: " + status);
									console.log(data);
								});
								
								$(".btn-automatizar").removeAttr("disabled");
							}else{
								alert('No ha seleccionado participante');
								break;
							}
							
							var elementosBpmnsNext = getElementsNext(elemento);
							
							if(elementosBpmnsNext != undefined){
								var j = 0;
								for(j = 0; j <= elementosBpmnsNext.length; j++){
									if(elementosBpmnsNext[j] != undefined){
										console.log("entra for");
										console.log("J " + elementosBpmnsNext[j]);
										var body = {
												"id_diagrama_elemento_bpmn" : elemento.id,
												"id_proceso" : proceso.idProceso,
												"elemento_next" : elementosBpmnsNext[j]
										}
										$.post("/api/elemento-bpmn/update-elemento-next", body , function(data, status){
											console.log("Estado: " + status);
											console.log(data);
										});
									}
								}
								
							}
						}
							
					}
				}
				
			}
			
			
			function getCargo(idLane){
				var idCargo = 0;
				participantes.forEach(function(elemento, indice){
					if(elemento.id == idLane){
						idCargo = elemento.id_cargo;
					}
				});	
				return idCargo;
			}
			
			function getElementsNext(elemento){
				var elementsNext = [];
				var sequencesFlow = elemento.businessObject.outgoing;
				var i = 0;
				if(sequencesFlow != undefined){
					for(i = 0; i <= sequencesFlow.length; i++){
						if(sequencesFlow[i] != undefined){
							console.log(sequencesFlow[i].targetRef.id);
							elementsNext.push(sequencesFlow[i].targetRef.id);
						}
					}
				}
				console.log(elementsNext);
				return elementsNext;
			}
			
			/*
			function getStartEvent(){
				var canvas = bpmnModeler.get('canvas');
				var startEvent = canvas._elementRegistry.filter(function(element) {
					  return (element.type === 'bpmn:StartEvent');
				});
				return startEvent;
			}*/
			
			
			
			
		</script>
    	<svg id="helper-svg" width="0" height="0" style="visibility: hidden; position: fixed"></svg>
	</section>
</body>

</html>
